<!DOCTYPE html>
<html>
<head>
  <title>Mapa do Brasil</title>
  <style>
    #map {
      height: 600px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script type="module">
    import { utils, data } from './app.js';
    var geojsonData;
    var centerMap = { lat: -11.938104, lng:  -55.090393 };

    function loadGeoJson(callback) {
      var xhr = new XMLHttpRequest();
      xhr.overrideMimeType("application/json");
      xhr.open("GET", "data/brazil-states.geojson", true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status == 200) {
          geojsonData = JSON.parse(xhr.responseText);
          callback();
        }
      };
      xhr.send(null);
    }

    function initMap() {
      loadGeoJson(function() {
        var map = new google.maps.Map(document.getElementById('map'), {
          center: centerMap, 
          zoom: 4,
          styles: [
            { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
            {
              featureType: "administrative.locality",
              elementType: "labels.text.fill",
              stylers: [{ color: "#d59563" }],
            },
            {
              featureType: "poi",
              elementType: "labels.text.fill",
              stylers: [{ color: "#d59563" }],
            },
            {
              featureType: "poi.park",
              elementType: "geometry",
              stylers: [{ color: "#263c3f" }],
            },
            {
              featureType: "poi.park",
              elementType: "labels.text.fill",
              stylers: [{ color: "#6b9a76" }],
            },
            {
              featureType: "road",
              elementType: "geometry",
              stylers: [{ color: "#38414e" }],
            },
            {
              featureType: "road",
              elementType: "geometry.stroke",
              stylers: [{ color: "#212a37" }],
            },
            {
              featureType: "road",
              elementType: "labels.text.fill",
              stylers: [{ color: "#9ca5b3" }],
            },
            {
              featureType: "road.highway",
              elementType: "geometry",
              stylers: [{ color: "#746855" }],
            },
            {
              featureType: "road.highway",
              elementType: "geometry.stroke",
              stylers: [{ color: "#1f2835" }],
            },
            {
              featureType: "road.highway",
              elementType: "labels.text.fill",
              stylers: [{ color: "#f3d19c" }],
            },
            {
              featureType: "transit",
              elementType: "geometry",
              stylers: [{ color: "#2f3948" }],
            },
            {
              featureType: "transit.station",
              elementType: "labels.text.fill",
              stylers: [{ color: "#d59563" }],
            },
            {
              featureType: "water",
              elementType: "geometry",
              stylers: [{ color: "#17263c" }],
            },
            {
              featureType: "water",
              elementType: "labels.text.fill",
              stylers: [{ color: "#515c6d" }],
            },
            {
              featureType: "water",
              elementType: "labels.text.stroke",
              stylers: [{ color: "#17263c" }],
            },
          ],
        });
        
        data.brazilianStates.forEach(function(estado) {
          const stateFeature = geojsonData.features.find(feature => feature.properties.sigla === estado.sigla);

          if (stateFeature) {
            const stateCoordinates = stateFeature.geometry.coordinates[0][0];

            const statePolygon = new google.maps.Polygon({
              paths: stateCoordinates.map(coord => ({ lat: coord[1], lng: coord[0] })),
              strokeColor: '#000000',
              strokeOpacity: 0.8,
              strokeWeight: 1,
              fillColor: estado.cor,
              fillOpacity: 0.6
            });

            statePolygon.setMap(map);
          }
        });

        data.brasilianCities.forEach(function(cidade) {
          var squareSize = 0.1;
          var citySquare = new google.maps.Polygon({
            paths: [
              { lat: cidade.lat + squareSize, lng: cidade.lng - squareSize },
              { lat: cidade.lat + squareSize, lng: cidade.lng + squareSize },
              { lat: cidade.lat - squareSize, lng: cidade.lng + squareSize },
              { lat: cidade.lat - squareSize, lng: cidade.lng - squareSize }
            ],
            strokeColor: cidade.cor,
            strokeOpacity: 1,
            strokeWeight: 2,
            fillColor: cidade.cor,
            fillOpacity: 0.6
          });

          citySquare.setMap(map);
        });

        data.conections.forEach(function(conexao) {
          var cidadeInicio = data.brasilianCities.find(cidade => cidade.nome === conexao.inicio);
          var cidadeFim = data.brasilianCities.find(cidade => cidade.nome === conexao.fim);

          if (cidadeInicio && cidadeFim) {
            var cityLine = new google.maps.Polyline({
              path: [
                { lat: cidadeInicio.lat, lng: cidadeInicio.lng },
                { lat: cidadeFim.lat, lng: cidadeFim.lng }
              ],
              strokeColor: conexao.cor,
              strokeOpacity: 1,
              strokeWeight: 2,
              map: map
            });
          }
        });
      });
    }

    function loadGoogleMapsScript() {
      fetch('/api/google-maps-key')
        .then(response => response.text())
        .then(apiKey => {
          var script = document.createElement("script");
          script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
          script.async = true;
          script.defer = true;
          document.head.appendChild(script);
        })
        .catch(error => {
          console.error('Error fetching API key:', error);
        });
    }
   
    window.initMap = initMap;

    window.onload = loadGoogleMapsScript;
  </script>
</body>
</html>